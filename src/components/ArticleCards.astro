---
import { getCollection } from 'astro:content';

// Get all documentation pages except the index
const allDocs = await getCollection('docs');
const articles = allDocs.filter(doc => doc.id !== 'index.mdx');

// Extract unique tags
const allTags = new Set<string>();
articles.forEach(article => {
  if (article.data.tags) {
    article.data.tags.forEach((tag: string) => allTags.add(tag));
  }
});
const uniqueTags = Array.from(allTags).sort();
---

<div class="article-cards-container">
  <div class="filters">
    <div class="search-box">
      <input
        type="text"
        id="search-input"
        placeholder="Search articles..."
        aria-label="Search articles"
      />
    </div>
    <div class="tag-filters">
      <label>Filter by tags:</label>
      <div class="tag-list">
        <button class="tag-filter active" data-tag="all">All</button>
        {uniqueTags.map(tag => (
          <button class="tag-filter" data-tag={tag}>{tag}</button>
        ))}
      </div>
    </div>
    <div class="sort-controls">
      <label for="sort-select">Sort by:</label>
      <select id="sort-select">
        <option value="title">Title</option>
        <option value="category">Category</option>
      </select>
    </div>
  </div>

  <div class="articles-grid" id="articles-grid">
    {articles.map(article => {
      const category = article.id.split('/')[0];
      const categoryName = category.replace(/^\d+-/, '').replace(/-/g, ' ');
      const tags = article.data.tags || [];
      const articleSlug = article.id.replace(/\.mdx?$/, '');
      
      return (
        <article class="article-card" data-tags={tags.join(',')}>
          <a href={`/${articleSlug}/`} class="card-link">
            <div class="card-header">
              <span class="category-badge">{categoryName}</span>
            </div>
            <h3>{article.data.title}</h3>
            <p class="description">{article.data.description}</p>
            {tags.length > 0 && (
              <div class="tags">
                {tags.map((tag: string) => (
                  <span class="tag">{tag}</span>
                ))}
              </div>
            )}
          </a>
        </article>
      );
    })}
  </div>

  <div id="no-results" class="no-results" style="display: none;">
    <p>No articles found matching your criteria.</p>
  </div>
</div>

<script>
  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', () => {
    // Search functionality
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const articlesGrid = document.getElementById('articles-grid') as HTMLElement;
    const noResults = document.getElementById('no-results') as HTMLElement;
    const tagFilters = document.querySelectorAll('.tag-filter');
    const sortSelect = document.getElementById('sort-select') as HTMLSelectElement;
    
    let activeTag = 'all';

    function filterAndSortArticles() {
    const searchTerm = searchInput.value.toLowerCase();
    const articles = Array.from(document.querySelectorAll('.article-card'));
    let visibleCount = 0;

    articles.forEach(article => {
      const element = article as HTMLElement;
      const title = element.querySelector('h3')?.textContent?.toLowerCase() || '';
      const description = element.querySelector('.description')?.textContent?.toLowerCase() || '';
      const tags = element.dataset.tags?.toLowerCase() || '';
      
      const matchesSearch = title.includes(searchTerm) || 
                           description.includes(searchTerm) || 
                           tags.includes(searchTerm);
      
      const matchesTag = activeTag === 'all' || tags.includes(activeTag.toLowerCase());
      
      if (matchesSearch && matchesTag) {
        element.style.display = 'block';
        visibleCount++;
      } else {
        element.style.display = 'none';
      }
    });

    // Sort visible articles
    const sortBy = sortSelect.value;
    const visibleArticles = articles.filter(a => (a as HTMLElement).style.display !== 'none');
    
    visibleArticles.sort((a, b) => {
      if (sortBy === 'title') {
        const titleA = (a as HTMLElement).querySelector('h3')?.textContent || '';
        const titleB = (b as HTMLElement).querySelector('h3')?.textContent || '';
        return titleA.localeCompare(titleB);
      } else if (sortBy === 'category') {
        const catA = (a as HTMLElement).querySelector('.category-badge')?.textContent || '';
        const catB = (b as HTMLElement).querySelector('.category-badge')?.textContent || '';
        return catA.localeCompare(catB);
      }
      return 0;
    });

    // Re-append sorted articles
    visibleArticles.forEach(article => {
      articlesGrid.appendChild(article);
    });

    // Show/hide no results message
    if (visibleCount === 0) {
      noResults.style.display = 'block';
    } else {
      noResults.style.display = 'none';
    }
  }

  // Event listeners
  searchInput.addEventListener('input', filterAndSortArticles);
  sortSelect.addEventListener('change', filterAndSortArticles);

  tagFilters.forEach(button => {
    button.addEventListener('click', () => {
      tagFilters.forEach(btn => btn.classList.remove('active'));
      button.classList.add('active');
      activeTag = button.getAttribute('data-tag') || 'all';
      filterAndSortArticles();
    });
  });
  });
</script>

<style>
  .article-cards-container {
    margin-top: 2rem;
  }

  .filters {
    background: var(--sl-color-gray-6);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 2rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .search-box input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    background: var(--sl-color-black);
    color: var(--sl-color-white);
    font-size: 1rem;
  }

  .search-box input:focus {
    outline: 2px solid var(--sl-color-accent);
    outline-offset: 2px;
  }

  .tag-filters label,
  .sort-controls label {
    font-weight: 600;
    margin-bottom: 0.5rem;
    display: block;
  }

  .tag-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag-filter {
    padding: 0.5rem 1rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    background: var(--sl-color-black);
    color: var(--sl-color-white);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.875rem;
  }

  .tag-filter:hover {
    background: var(--sl-color-gray-5);
  }

  .tag-filter.active {
    background: var(--sl-color-accent);
    border-color: var(--sl-color-accent);
  }

  .sort-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .sort-controls select {
    padding: 0.5rem;
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.375rem;
    background: var(--sl-color-black);
    color: var(--sl-color-white);
    cursor: pointer;
  }

  .articles-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  .article-card {
    border: 1px solid var(--sl-color-gray-5);
    border-radius: 0.5rem;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
    background: var(--sl-color-gray-6);
  }

  .article-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .card-link {
    display: block;
    padding: 1.5rem;
    text-decoration: none;
    color: inherit;
  }

  .card-header {
    margin-bottom: 1rem;
  }

  .category-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    background: var(--sl-color-accent);
    color: var(--sl-color-black);
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
  }

  .article-card h3 {
    margin: 0 0 0.5rem 0;
    font-size: 1.25rem;
    color: var(--sl-color-white);
  }

  .description {
    color: var(--sl-color-gray-2);
    font-size: 0.875rem;
    margin-bottom: 1rem;
    line-height: 1.5;
  }

  .tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .tag {
    padding: 0.25rem 0.5rem;
    background: var(--sl-color-gray-5);
    color: var(--sl-color-gray-2);
    border-radius: 0.25rem;
    font-size: 0.75rem;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--sl-color-gray-3);
  }

  @media (max-width: 768px) {
    .articles-grid {
      grid-template-columns: 1fr;
    }
    
    .filters {
      padding: 1rem;
    }
    
    .sort-controls {
      flex-direction: column;
      align-items: flex-start;
    }
  }
</style>
